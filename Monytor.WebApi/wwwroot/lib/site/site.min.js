var charts=new Array,defaultTimeRangeInDays=5,nonNumericConfig={type:"line",options:{responsive:!0,title:{display:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0},offset:!1,bounds:"ticks",type:"time",time:{unit:"day",distribution:"linear",stepSize:1}}],yAxes:[{type:"category",position:"left",display:!0,scaleLabel:{display:!1},ticks:{reverse:!0,callback:function(e,t,a){return 15<e.length?e.substring(0,15)+"...":e},autoSkip:!0,autoSkipPadding:10,source:"auto",maxTicksLimit:10}}]}}},getdefaultApiUrl=function(){return window.location.origin+"/api"},getSeriesApiUrl=function(){return sessionStorage.defaultSourceUrl+"/series"},dateRangePickerCallback=function(e,t){$("#dateRangePicker span").html(e.format("MMMM D, YYYY")+" - "+t.format("MMMM D, YYYY"))},updateAllCharts=function(e,t){charts=new Array,$("#chartArea").empty();var a=(new Dashboard).load();a.views.forEach(function(e){e.collectors.forEach(function(e){t&&(t.startDate&&(e.start=t.startDate.format("YYYY-MM-DD")),t.endDate&&(e.end=t.endDate.format("YYYY-MM-DD")))})}),(new Dashboard).save(a),loadFromStore()};$(document).ready(function(){$("#daterange").daterangepicker({startDate:moment(),endDate:moment(),ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}},dateRangePickerCallback),$("#daterange").on("apply.daterangepicker",updateAllCharts),dateRangePickerCallback(moment(),moment()),"undefined"==typeof Storage&&alert("No support for Web Storage. Please update your browser."),sessionStorage.defaultSourceUrl||(sessionStorage.defaultSourceUrl=getdefaultApiUrl()),sessionStorage.defaultTimeRangeInDays||(sessionStorage.defaultTimeRangeInDays=defaultTimeRangeInDays),loadAllSeriesGroupsViaUrl(getSeriesApiUrl());var e=new URL(window.location.href).searchParams.get("view");null===e?(sessionStorage.dashboard?loadFromStore():sessionStorage.dashboard=JSON.stringify(new Dashboard),updateAllCharts(null,$("#daterange"))):loadDashboardFromDb(e)}),$("#addViewButton").click(function(){var e=saveNewView(),t=$("#charttype option:selected").text(),a=insertChart(e,t);addCollectorForNewView(e,a),updateChartConfigDialog(e,a)}),$("#group").change(function(){var e=this.value,t=getDefaultJsonGroupTagDataFromStore()[e],a=$("#tag");setTagsFromArray(t.value,a,null)}),$("#addView").click(function(){var e=moment();$("#start").val(moment(e).subtract(sessionStorage.defaultTimeRangeInDays,"days").format("YYYY-MM-DD")),$("#end").val(e.format("YYYY-MM-DD"))}),$("#saveSettingButton").click(function(){var e=$("#defaultSourceUrlId").val();sessionStorage.defaultSourceUrl=e;var t=$("#defaultTimeRangeId").val();sessionStorage.defaultTimeRangeInDays=t}),$("#settings").click(function(){$("#defaultSourceUrlId").val(sessionStorage.defaultSourceUrl),$("#defaultTimeRangeId").val(sessionStorage.defaultTimeRangeInDays)});var loadFromStore=function(){var e=0,t=(new Dashboard).load();for(e=0;e<t.views.length;e++){var a=t.views[e].collectors[0].chartType,o=insertChart(e,a);updateChartConfigDialog(e,o);var r=0;for(r=0;r<t.views[e].collectors.length;r++)addCollector(o,r)}},loadAllSeriesGroupsViaUrl=function(t){null!==t&&$.ajax({url:t}).then(function(e){setDefaultJsonGroupTagDataToStore(e);var t=$(document).find("#group"),a=$(document).find("#tag");setGroupTagDataToControls(t,a,null,null)}).catch(function(e){alert("'"+e.status+" "+e.statusText+"' for: "+t)})},setGroupTagDataToControls=function(e,t,a,o){e.empty(),t.empty();var r=getDefaultJsonGroupTagDataFromStore();if(null!==r){for(var n=0,s=0;s<r.length;++s){var l=r[s].key;e.append($("<option>",{value:s,text:l})),l===a&&(n=s)}if(r&&0!==r.length){var i=r[0].value;0<n&&n<r.length&&(e.val(n),i=r[n].value),setTagsFromArray(i,t,o)}}},setDefaultJsonGroupTagDataToStore=function(e){sessionStorage.defaultGroupTagData=JSON.stringify(e)},getDefaultJsonGroupTagDataFromStore=function(){return void 0===sessionStorage.defaultGroupTagData?null:JSON.parse(sessionStorage.defaultGroupTagData)},createEmptyChart=function(e,t){"undefined"===t&&(t="line");var a=e.getContext("2d");return new Chart(a,{type:t.toLowerCase(),options:{responsive:!0,scales:{yAxes:[{ticks:{}}],xAxes:[{display:!0,offset:!1,bounds:"ticks",scaleLabel:{display:!0},type:"time",time:{unit:"day",distribution:"linear",stepSize:1,displayFormats:{day:"YY-MM-DD"}},tooltips:{mode:"index",intersect:!1},hover:{mode:"nearest",intersect:!0},ticks:{autoSkip:!0,autoSkipPadding:0,source:"auto"}}]}}})},randomColorGenerator=function(){return"#"+(Math.random().toString(16)+"0000000").slice(2,8)},setTagsFromArray=function(e,t,a){t.empty();var o=0;for(tagIndex=0;tagIndex<e.length;++tagIndex){var r=e[tagIndex];t.append($("<option>",{value:tagIndex,text:r})),r===a&&(o=tagIndex)}0<o&&o<e.length&&t.val(o)},insertChart=function(e,t){var a=Math.floor(1e9*Math.random()+1),o={chartnr:e,linkId:a},r=$("#chartTemplate")[0],n=Mustache.render(r.innerHTML,o),s=document.createElement("div");$(s).attr("class","viewRoot"),$(s).attr("id",a),$(s).html(n);var l=$(s).find("canvas")[0];$("#chartArea").append(s);var i={key:a,value:createEmptyChart(l,t)};return charts[a]=i,a},updateChartConfigDialog=function(e,o){var t=(new Dashboard).load();if(0!==t.views.length){var a=t.views[e];if(0!==a.collectors.length){var r=a.collectors[0],n=$("#"+o),s=$(n).find("#start"+o),l=$(n).find("#end"+o),i=$(n).find("#group"+o),d=$(n).find("#tag"+o),u=$(n).find("#charttype"+o);setGroupTagDataToControls(i,d,r.group,r.tag),s.val(moment(r.start).format(moment.HTML5_FMT.DATE)),l.val(moment(r.end).format(moment.HTML5_FMT.DATE)),u.val(r.chartType),i.on("change",function(){var e=this.value,t=getDefaultJsonGroupTagDataFromStore()[e],a=$("#tag"+o);setTagsFromArray(t.value,a,null)}),$(n).find("#update"+o).click(updateClick),$(n).find(".chart-close").click(closeChart)}}};$("#updateGroupTag").click(function(){}),$("#closeViews").click(function(){charts=new Array,$("#chartArea").empty(),(new Dashboard).save(new Dashboard)});var addCollector=function(e,t){var a=getElementIndex($("#"+e)),o=(new Dashboard).load().views[a].collectors[t],r=o.group,n=o.tag,s=o.start,l=o.end,i=o.meanValueType;addCollectorForValues(e,r,n,s,l,i)},updateCollector=function(e,t){var a=getElementIndex($("#"+e)),o=(new Dashboard).load().views[a].collectors[t],r=o.group,n=o.tag,s=o.start,l=o.end,i=o.meanValueType;charts[e].value.data.datasets=[],addCollectorForValues(e,r,n,s,l,i)},addChart=function(e,t,a,o,r,n){var s=randomColorGenerator();if(charts[e]){var l=charts[e].value;if(l.data.datasets.push({label:a+": "+o,borderColor:s,backgroundColor:Color(s).alpha(.5).rgbString(),fill:!1,data:r}),l.data.labels=t,n)l.options.scales.yAxes=[{ticks:{}}],l.data.yLabels=null;else{var i=[new Set(r)];l.options.scales.yAxes=nonNumericConfig.options.scales.yAxes,l.data.yLabels=i.reverse()}l.update()}},addCollectorForNewView=function(e,t){var a=(new Dashboard).load().views[e].collectors[0],o=a.group,r=a.tag,n=a.start,s=a.end,l=a.meanValueType;addCollectorForValues(t,o,r,n,s,l),$("#start"+t).val(n),$("#end"+t).val(s),$("#group"+t).text(o),$("#tag"+t).text(r)},addCollectorForValues=function(i,d,u,e,t,a){if(""!==d&&""!==u){var o=getSeriesApiUrl(),c=getUrlRequestSeries(o,e,t,d,u,a);$.ajax({url:c}).then(function(e){if(void 0===e&&e.length<=0)console.debug(c+": result is empty");else{var t=e.map(function(e){return e.value}),a=e.map(function(e){return moment(e.time)}),o=0<t.length&&$.isNumeric(t[0]),r=moment.max(a),n=moment.min(a),s=a.map(function(e){return e.toISOString()}),l=moment.duration(r.diff(n));0<l.years()?"year":0<l.months()&&"month",addChart(i,s,d,u,t,o)}})}},closeChart=function(e){var t=$(this).closest(".viewRoot"),a=getElementIndex(t),o=(new Dashboard).load();o.views.splice(a,1),(new Dashboard).save(o),t.remove()};function getElementIndex(e){return e.parent().children().index(e)}var getUrlRequestSeries=function(e,t,a,o,r,n){var s=moment(a).add(1,"day").subtract(1,"second").toISOString(),l=encodeURIComponent(r),i=e+"/"+t+"/"+s+"/"+encodeURIComponent(o)+"/"+l;return null!==n&&""!==n&&(i=i+"?meanValueType="+n),i},saveNewView=function(){var e=$("#group option:selected").text(),t=$("#tag option:selected").text(),a=$("#start").val(),o=$("#end").val(),r=$("#charttype option:selected").text(),n=$("#meanValueSelect option:selected").val(),s=(new Dashboard).load(),l=new Collector;l.group=e,l.tag=t,l.start=a,l.end=o,l.chartType=r,l.meanValueType=n;var i=new View;return i.collectors.push(l),s.views.push(i),(new Dashboard).save(s),s.views.length-1},updateClick=function(e){var t=$(this).closest(".viewRoot"),a=t.attr("id"),o=$(document).find("#group"+a+" option:selected").text(),r=$(document).find("#tag"+a+" option:selected").text(),n=$(document).find("#end"+a).val(),s=$("#start"+a).val(),l=getElementIndex(t),i=JSON.parse(sessionStorage.dashboard),d=i.views[l],u=new Collector;u.group=o,u.tag=r,u.start=s,u.end=n,d.collectors=[],d.collectors.push(u),(new Dashboard).save(i),updateCollector(a,d.collectors.length-1)},delay=function(){var o=0;return function(e,t,a){clearTimeout(o),o=setTimeout(e,a,t)}}();function Collector(){this.group="",this.tag="",this.start=null,this.end=null,this.chartType="line",this.meanValueType=null}function View(){this.jsonData=null,this.collectors=new Array}function Dashboard(){this.views=new Array}Dashboard.prototype.load=function(){return JSON.parse(sessionStorage.dashboard)},Dashboard.prototype.save=function(e){sessionStorage.dashboard=JSON.stringify(e)};
var getViewCollectionApiUrl=function(){return sessionStorage.defaultSourceUrl+"/ViewCollection"},getUrlForViewCollectionApiWithId=function(e){return getViewCollectionApiUrl()+"/"+e},getUrlForViewForViewCollectionApiWithId=function(e){return window.location.origin+"/?view="+e},loadDashboardFromDb=function(e){if(null!=e){var t=getUrlForViewCollectionApiWithId(e);$.ajax(t).then(function(e){if(null!=e){var t=e.views.length;if(0!=t){for(var i=moment().utc().endOf("day"),o=new Dashboard,a=0;a<t;a++){(n=e.views[a]).position;var n,l=n.group,r=n.tag,s=n.range,c=moment.duration(s),p=i.clone().subtract(c),u=new Collector;u.group=l,u.tag=r,u.end=i.utc().toISOString(),u.start=p.toISOString(),u.chartType=n.chartType,u.meanValueType=n.meanValueType,(n=new View).collectors.push(u),o.views.push(n)}(new Dashboard).save(o),loadFromStore()}}}).catch(function(e){alert("'"+e.status+" "+e.statusText+"' for: "+t)})}};$("#loadViewCollection").click(function(){var t=getViewCollectionApiUrl();$.ajax({url:t}).then(function(e){for(var t=[],i=0;i<e.length;i++){var o=getUrlForViewForViewCollectionApiWithId(e[i].id),a=0;null!=e[i].views&&(a=e[i].views.length),t.push('<a href="'+o+'" class="list-group"><div class="list-group-item"><div class="d-flex justify-content-between align-items-center"><h5 class="">'+e[i].name+'</h5><span class="badge badge-primary badge-pill">'+a+'</span></div><p class="">'+e[i].description+"</p></div></a>")}$("#loadViewListGroup").empty(),$("#loadViewListGroup").append(t.join(""))}).catch(function(e){alert("'"+e.status+" "+e.statusText+"' for: "+t)})}),$("#saveViewCollectionModal-save").click(function(){for(var e=$("#saveViewCollectionModal-name").val(),t=$("#saveViewCollectionModal-description").val(),i=(new Dashboard).load(),o={Name:e,Description:t,Views:new Array},a=0;a<i.views.length;a++)if(0!=i.views[a].collectors.length){var n=i.views[a].collectors[0],l=moment(n.end),r=moment(n.start),s=l.diff(r),c=moment(s).format("D.HH:mm:ss");o.Views.push({Position:a,Group:n.group,Tag:n.tag,Range:c,ChartType:n.chartType,MeanValueType:n.meanValueType})}var p=getViewCollectionApiUrl();$.ajax({type:"POST",url:p,data:JSON.stringify(o),contentType:"application/json",dataType:"json"})});